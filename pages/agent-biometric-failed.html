<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verifikasi Gagal - Portal Agent Perlinsos</title>
    <link rel="stylesheet" href="perlinsos-styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="mobile-container">
        <!-- Content -->
        <div class="content" style="padding-top: var(--spacing-3xl);">
            <!-- Error Animation -->
            <div style="text-align: center; margin-bottom: var(--spacing-3xl);">
                <div style="width: 120px; height: 120px; margin: 0 auto var(--spacing-xl); background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 48px; color: var(--white-primary); box-shadow: var(--shadow-xl); animation: errorShake 0.5s ease-in-out;">
                    <i class="fas fa-times"></i>
                </div>
                <h1 style="font-size: 28px; font-weight: 700; color: var(--gray-900); margin-bottom: var(--spacing-sm);">Verifikasi Gagal</h1>
                <p style="color: var(--text-secondary); font-size: 16px; line-height: 1.5;">Sistem tidak dapat memverifikasi identitas Anda. Silakan coba lagi atau hubungi supervisor.</p>
            </div>

            <!-- Error Details -->
            <div class="card" style="margin-bottom: var(--spacing-xl);">
                <div class="card-header" style="background: #FEF2F2; color: #DC2626;">
                    <h3 style="font-size: 16px; margin: 0; display: flex; align-items: center; gap: var(--spacing-sm);">
                        <i class="fas fa-exclamation-triangle"></i>
                        Detail Kegagalan Verifikasi
                    </h3>
                </div>
                <div class="card-content">
                    <div class="verification-summary">
                        <!-- Error Reason -->
                        <div id="errorReason" style="margin-bottom: var(--spacing-xl);">
                            <div style="background: #FEF2F2; padding: var(--spacing-lg); border-radius: var(--radius-lg); border-left: 4px solid #DC2626;">
                                <h4 style="font-size: 14px; font-weight: 600; color: #DC2626; margin-bottom: var(--spacing-sm);">Alasan Kegagalan:</h4>
                                <p id="errorMessage" style="font-size: 14px; color: var(--text-primary); margin: 0; line-height: 1.5;">Pencocokan wajah tidak mencapai ambang batas minimum yang diperlukan untuk verifikasi keamanan.</p>
                            </div>
                        </div>

                        <!-- Verification Steps Status -->
                        <div class="checklist">
                            <div class="checklist-item" id="step1Status" style="background: var(--green-light);">
                                <div class="check-icon" style="background: var(--green-success);">
                                    <i class="fas fa-check" style="font-size: 12px;"></i>
                                </div>
                                <div class="checklist-text">
                                    <strong>Deteksi Wajah</strong><br>
                                    <span style="color: var(--green-success); font-size: 13px; font-weight: 600;">Berhasil - Wajah terdeteksi dengan baik</span>
                                </div>
                            </div>
                            <div class="checklist-item" id="step2Status" style="background: var(--green-light);">
                                <div class="check-icon" style="background: var(--green-success);">
                                    <i class="fas fa-check" style="font-size: 12px;"></i>
                                </div>
                                <div class="checklist-text">
                                    <strong>Tes Liveness</strong><br>
                                    <span style="color: var(--green-success); font-size: 13px; font-weight: 600;">Berhasil - Kehadiran fisik terkonfirmasi</span>
                                </div>
                            </div>
                            <div class="checklist-item" id="step3Status" style="background: #FEF2F2;">
                                <div class="check-icon" style="background: #DC2626;">
                                    <i class="fas fa-times" style="font-size: 12px;"></i>
                                </div>
                                <div class="checklist-text">
                                    <strong>Pencocokan Wajah</strong><br>
                                    <span style="color: #DC2626; font-size: 13px; font-weight: 600;">Gagal - Tingkat kemiripan di bawah ambang batas</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Possible Issues -->
            <div class="card" style="margin-bottom: var(--spacing-xl);">
                <div class="card-header" style="background: var(--gold-light); color: var(--gold-accent);">
                    <h4 style="font-size: 16px; margin: 0; display: flex; align-items: center; gap: var(--spacing-sm);">
                        <i class="fas fa-lightbulb"></i>
                        Kemungkinan Penyebab
                    </h4>
                </div>
                <div class="card-content">
                    <ul style="margin: 0; padding-left: 20px; font-size: 14px; line-height: 1.6;">
                        <li style="margin-bottom: var(--spacing-sm);">Pencahayaan kurang optimal saat pengambilan foto</li>
                        <li style="margin-bottom: var(--spacing-sm);">Posisi wajah tidak sesuai dengan foto profil agent</li>
                        <li style="margin-bottom: var(--spacing-sm);">Menggunakan aksesoris (kacamata, masker, topi)</li>
                        <li style="margin-bottom: var(--spacing-sm);">Kualitas kamera tidak mencukupi</li>
                        <li style="margin-bottom: var(--spacing-sm);">Foto profil agent perlu diperbarui</li>
                        <li>Gangguan jaringan selama proses verifikasi</li>
                    </ul>
                </div>
            </div>

            <!-- Actions -->
            <div style="margin-bottom: var(--spacing-xl);">
                <h3 style="font-size: 18px; font-weight: 600; margin-bottom: var(--spacing-lg); color: var(--gray-900);">Apa yang dapat Anda lakukan?</h3>
                
                <!-- Retry Option -->
                <div class="card" style="margin-bottom: var(--spacing-lg);">
                    <div class="card-content" style="text-align: center;">
                        <div style="width: 48px; height: 48px; margin: 0 auto var(--spacing-lg); background: var(--blue-light); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-redo" style="color: var(--blue-primary); font-size: 20px;"></i>
                        </div>
                        <h4 style="font-size: 16px; margin-bottom: var(--spacing-sm); color: var(--gray-900);">Coba Lagi</h4>
                        <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: var(--spacing-lg); line-height: 1.5;">
                            Pastikan pencahayaan cukup dan posisi wajah sesuai dengan panduan
                        </p>
                        <button onclick="retryVerification()" class="btn btn-primary btn-full">
                            <i class="fas fa-redo"></i>
                            Ulangi Verifikasi Biometrik
                        </button>
                    </div>
                </div>

                <!-- Contact Support -->
                <div class="card" style="margin-bottom: var(--spacing-lg);">
                    <div class="card-content" style="text-align: center;">
                        <div style="width: 48px; height: 48px; margin: 0 auto var(--spacing-lg); background: var(--gold-light); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-headset" style="color: var(--gold-accent); font-size: 20px;"></i>
                        </div>
                        <h4 style="font-size: 16px; margin-bottom: var(--spacing-sm); color: var(--gray-900);">Hubungi Supervisor</h4>
                        <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: var(--spacing-lg); line-height: 1.5;">
                            Jika masalah berlanjut, hubungi supervisor untuk bantuan teknis
                        </p>
                        <div style="display: flex; gap: var(--spacing-sm);">
                            <a href="tel:14045" class="btn btn-outline" style="flex: 1;">
                                <i class="fas fa-phone"></i>
                                Call Center
                            </a>
                            <a href="mailto:agent-support@perlinsos.go.id" class="btn btn-outline" style="flex: 1;">
                                <i class="fas fa-envelope"></i>
                                Email Support
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Alternative Login -->
                <div class="card">
                    <div class="card-content" style="text-align: center;">
                        <div style="width: 48px; height: 48px; margin: 0 auto var(--spacing-lg); background: var(--gray-100); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-user-cog" style="color: var(--gray-600); font-size: 20px;"></i>
                        </div>
                        <h4 style="font-size: 16px; margin-bottom: var(--spacing-sm); color: var(--gray-900);">Login dengan Metode Lain</h4>
                        <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: var(--spacing-lg); line-height: 1.5;">
                            Kembali ke halaman login dan gunakan verifikasi alternatif jika tersedia
                        </p>
                        <button onclick="backToLogin()" class="btn btn-secondary btn-full">
                            <i class="fas fa-arrow-left"></i>
                            Kembali ke Login
                        </button>
                    </div>
                </div>
            </div>

            <!-- Error Log for Support -->
            <div class="alert alert-warning">
                <div class="alert-icon">
                    <i class="fas fa-code"></i>
                </div>
                <div class="alert-content">
                    <h4>Informasi Teknis</h4>
                    <p style="font-family: monospace; font-size: 12px; background: var(--gray-100); padding: var(--spacing-sm); border-radius: var(--radius-sm); margin-top: var(--spacing-sm);">
                        Error ID: <span id="errorId">ERR-BIO-20240715-001234</span><br>
                        Timestamp: <span id="errorTime">2024-07-15 15:42:33 WIB</span><br>
                        Agent ID: AGT-001234
                    </p>
                    <p style="font-size: 13px; margin-top: var(--spacing-sm);">Berikan Error ID ini kepada tim support untuk penanganan lebih lanjut.</p>
                </div>
            </div>

            <!-- Retry Counter -->
            <div id="retryCounter" style="text-align: center; margin-top: var(--spacing-xl);">
                <p style="font-size: 13px; color: var(--text-secondary);">
                    Percobaan ke-<span id="attemptCount">1</span> dari 3 | 
                    <span id="remainingAttempts">2</span> percobaan tersisa
                </p>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="home-indicator"></div>
        </div>
    </div>

    <style>
        @keyframes errorShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .card {
            animation: fadeInUp 0.6s ease-out;
        }
        
        .card:nth-child(2) { animation-delay: 0.1s; }
        .card:nth-child(3) { animation-delay: 0.2s; }
        .card:nth-child(4) { animation-delay: 0.3s; }
    </style>

    <script>
        let attemptCount = 1;
        const maxAttempts = 3;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Set error timestamp
            const now = new Date();
            document.getElementById('errorTime').textContent = now.toLocaleString('id-ID');
            
            // Generate error ID
            const errorId = 'ERR-BIO-' + now.getFullYear() + 
                           String(now.getMonth() + 1).padStart(2, '0') + 
                           String(now.getDate()).padStart(2, '0') + '-' + 
                           Math.random().toString(36).substring(2, 8).toUpperCase();
            document.getElementById('errorId').textContent = errorId;

            // Get attempt count from storage or URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const attempt = parseInt(urlParams.get('attempt')) || 1;
            
            updateAttemptCount(attempt);
            generateRandomError();
        });

        function updateAttemptCount(attempt) {
            attemptCount = Math.min(attempt, maxAttempts);
            document.getElementById('attemptCount').textContent = attemptCount;
            document.getElementById('remainingAttempts').textContent = Math.max(maxAttempts - attemptCount, 0);
            
            // Disable retry if max attempts reached
            if (attemptCount >= maxAttempts) {
                const retryButton = document.querySelector('button[onclick="retryVerification()"]');
                retryButton.disabled = true;
                retryButton.innerHTML = '<i class="fas fa-ban"></i> Batas Percobaan Tercapai';
                retryButton.classList.remove('btn-primary');
                retryButton.classList.add('btn-secondary');
                
                document.getElementById('retryCounter').innerHTML = 
                    '<p style="font-size: 13px; color: #DC2626; font-weight: 600;">Batas maksimal percobaan telah tercapai. Silakan hubungi supervisor.</p>';
            }
        }

        function generateRandomError() {
            const errors = [
                {
                    step: 3,
                    message: "Pencocokan wajah tidak mencapai ambang batas minimum yang diperlukan untuk verifikasi keamanan.",
                    stepStatuses: [true, true, false]
                },
                {
                    step: 2,
                    message: "Tes liveness gagal. Sistem tidak dapat mengkonfirmasi kehadiran fisik yang valid.",
                    stepStatuses: [true, false, false]
                },
                {
                    step: 1,
                    message: "Deteksi wajah gagal. Pastikan wajah Anda terlihat jelas dan pencahayaan memadai.",
                    stepStatuses: [false, false, false]
                }
            ];

            const randomError = errors[Math.floor(Math.random() * errors.length)];
            document.getElementById('errorMessage').textContent = randomError.message;
            
            // Update step statuses
            const steps = ['step1Status', 'step2Status', 'step3Status'];
            const stepNames = ['Deteksi Wajah', 'Tes Liveness', 'Pencocokan Wajah'];
            
            steps.forEach((stepId, index) => {
                const stepElement = document.getElementById(stepId);
                const checkIcon = stepElement.querySelector('.check-icon');
                const statusText = stepElement.querySelector('.checklist-text span');
                
                if (randomError.stepStatuses[index]) {
                    stepElement.style.background = 'var(--green-light)';
                    checkIcon.style.background = 'var(--green-success)';
                    checkIcon.innerHTML = '<i class="fas fa-check" style="font-size: 12px;"></i>';
                    statusText.style.color = 'var(--green-success)';
                    statusText.textContent = 'Berhasil - ' + (index === 0 ? 'Wajah terdeteksi dengan baik' : 
                                                             index === 1 ? 'Kehadiran fisik terkonfirmasi' : 
                                                             'Cocok dengan profil agent');
                } else {
                    stepElement.style.background = '#FEF2F2';
                    checkIcon.style.background = '#DC2626';
                    checkIcon.innerHTML = '<i class="fas fa-times" style="font-size: 12px;"></i>';
                    statusText.style.color = '#DC2626';
                    statusText.textContent = 'Gagal - ' + (index === 0 ? 'Wajah tidak terdeteksi dengan jelas' : 
                                                          index === 1 ? 'Tes liveness tidak berhasil' : 
                                                          'Tingkat kemiripan di bawah ambang batas');
                }
            });
        }

        function retryVerification() {
            if (attemptCount >= maxAttempts) {
                alert('Batas maksimal percobaan telah tercapai. Silakan hubungi supervisor.');
                return;
            }
            
            // Increment attempt count
            const nextAttempt = attemptCount + 1;
            
            // Show loading state
            const button = document.querySelector('button[onclick="retryVerification()"]');
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memulai Ulang...';
            button.disabled = true;
            
            // Redirect to verification page with attempt parameter
            setTimeout(() => {
                window.location.href = `agent-biometric-verification.html?attempt=${nextAttempt}`;
            }, 1000);
        }

        function backToLogin() {
            if (confirm('Apakah Anda yakin ingin kembali ke halaman login? Semua progress verifikasi akan hilang.')) {
                window.location.href = 'agent-login.html';
            }
        }

        // Store attempt count in session storage
        window.addEventListener('beforeunload', function() {
            sessionStorage.setItem('biometricAttempt', attemptCount);
        });
    </script>
</body>
</html>